# ESP32-S2 MQTT智能开关

基于ESP32-S2的MQTT智能开关控制程序，具有快速IO响应、WiFi配网和参数保存功能。

## 功能特点

- **快速IO响应**：针对单核ESP32-S2优化的非阻塞设计，实现上电后IO立即响应
- **WiFi配网**：使用WiFiManager库实现简易配网
- **MQTT控制**：支持通过MQTT协议远程控制开关状态
- **参数持久化**：使用Preferences库保存配置参数
- **硬件按钮控制**：支持按钮短按切换开关状态，长按重置配置
- **状态反馈**：通过MQTT消息反馈当前设备状态

## 硬件要求

- ESP32-S2开发板
- 默认IO配置（可通过配网页面修改）：
  - 按钮引脚：GPIO 9（上拉输入）
  - LED指示灯：GPIO 8（输出）
  - 电源控制：GPIO 7（输出）

## 使用方法

### 初次使用

1. 给设备上电，自动进入配网模式
2. 使用手机或电脑连接名为"ESP32S2_AP"的WiFi热点
3. 在弹出的配置页面中设置：
   - WiFi网络名称和密码
   - MQTT服务器参数（服务器地址、端口、用户名、密码）
   - MQTT主题
   - IO引脚配置
4. 保存后设备将自动连接到配置的WiFi网络和MQTT服务器

### MQTT控制命令

设备订阅`{主题}/command`主题，接收以下命令：

- `on`：打开开关
- `off`：关闭开关
- `toggle`：切换开关状态
- `status`：查询当前状态

设备发布到`{主题}`主题，消息格式为JSON：
```json
{
  "status": "状态信息",
  "power": "on/off"
}
```

### 按钮操作

- **短按**：切换开关状态
- **长按5秒**：重置所有配置，恢复出厂设置

## 优化说明

本程序针对ESP32-S2单核芯片的IO响应速度进行了以下优化：

1. **非阻塞设计**：
   - 采用状态机方式处理网络连接
   - 优先处理IO操作，确保按钮检测最高优先级
   - 网络连接失败不会阻塞IO操作
   
2. **IO引脚优化**：
   - 使用整数类型存储引脚号，避免反复atoi()转换
   - 尽早初始化IO状态，确保上电后立即响应
   
3. **按钮检测优化**：
   - 改进按钮检测算法，增加消抖处理
   - 实现短按功能切换电源状态
   
4. **网络连接优化**：
   - 延迟WiFi和MQTT初始化，优先处理IO操作
   - 设置较短的网络连接超时时间
   - 使用随机客户端ID防止MQTT连接冲突
   
5. **延时优化**：
   - 减少主循环延时至5ms，提高响应速度
   - 使用millis()进行非阻塞定时控制

## 库依赖

- WiFi.h - ESP32 WiFi库
- WiFiManager.h - WiFi配网管理库
- PubSubClient.h - MQTT客户端库
- Preferences.h - ESP32参数保存库

## 故障排除

1. **设备无法连接WiFi**
   - 长按按钮5秒重置配置
   - 重新进行配网操作

2. **MQTT无法连接**
   - 检查MQTT服务器配置
   - 检查网络连接状态

3. **按钮无响应**
   - 检查按钮引脚配置
   - 检查按钮是否正确连接

4. **开关无法控制**
   - 检查电源控制引脚配置
   - 检查继电器或其他输出设备连接

## 注意事项

1. 首次使用需要配置WiFi和MQTT参数
2. 修改GPIO配置后需要重新接线
3. 请确保供电稳定，避免频繁断电
4. 建议使用5V-12V直流电源供电

## 技术支持

如有问题请提交Issue或联系开发者。
